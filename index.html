<!DOCTYPE html>
<html class="cinema_bg">
	<head>
		<title>WebSocket Video Sync</title>

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="mobile-web-app-capable" content="yes">

		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" >

		<link rel="icon" href="favicon.png">
		<link rel="apple-touch-icon" href="favicon.png">
		<link rel="stylesheet" href="bootstrap.min.css">
		<script src="JQ.js"></script>
		<!-- <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script> -->
		<script src="jquery.achexws.js"></script>
		<script>
var backgroundCs = [
    {cname:'cinema_bg'},
    {cname:'brokkoli_bg'},
    {cname:'cosmos_bg'},
    {cname:'black-scales_bg'},
    {cname:'diagmonds_bg'}
];
function setBg(newBgNum) {
    if( typeof(window.localStorage.currBg) === 'undefined' 
        || isNaN(window.localStorage.currBg) 
        || typeof(backgroundCs[window.localStorage.currBg]) !== 'object') {
        
        window.localStorage.currBg = 0;
    }

    if(isNaN(newBgNum) || typeof(backgroundCs[newBgNum]) !== 'object') {
        newBgNum = window.localStorage.currBg;
    }
    else window.localStorage.currBg = newBgNum;

    document.getElementsByTagName('html')[0].className = backgroundCs[newBgNum].cname;
}
		</script>
<style>
html{
    background-color: #000;
    color: #ededed;
}
body{
background: none transparent;
color: #ededed;
}
#the-video {
position: relative;
top: 35px;
background-color: rgba(0,0,0,0.92);
box-shadow: 0 0 10px 2px rgba(0,0,0,0.8);
}
#logo{
vertical-align: bottom;
}
.from{
padding-top:10px;
font-weight:bold;
text-decoration: underline;
}
.msg{
color:#ededed;
padding: 5px;
}
.msg a {
    color: #2cf;
}
.msg a:hover {
    color: #0ff;
}
.msg a:visited {
    color: #09d;
}
.sys-msg {
    color: #baf;
}

#chat_cont{
display:table;
text-align:left;
position:fixed;
bottom: 40px;
width: 100%;
}
#chat_cont> div{
display:table-row;
}
#chat_cont > div> div{
display:table-cell;
}
#users-title {
text-align: center;
padding: 5px;
visibility: hidden;
}
#username-container {
visibility: hidden;
}
#username{
font-weight:bold;
color: #fafafa;
padding: 5px;
}

#chat_window{
max-height: 400px;
overflow-y:auto;
text-align:right;
padding: 5px;
}
#chat_window>div{
display: inline-block;
background: linear-gradient(135deg, rgba(0,0,0,0) 0%,rgba(20,20,20,0.80) 100%); 
border-radius:7px;
box-shadow: 0 0 16px -1px rgba(0,0,0,0.8);
padding: 5px;
margin-top: 5px;
}
#chat_users{
overflow-y:auto;
width: 150px;
text-align: right;
padding: 5px;
max-height: 400px;
vertical-align: bottom;
}
#chat_users>div{
background:linear-gradient(135deg, rgba(0,0,0,0) 0%,rgba(20,20,20,0.80) 100%); 
padding: 5px;
border-radius:7px;
box-shadow: 0 0 16px -1px rgba(0,0,0,0.8);
text-align: center;
vertical-align: bottom;
margin-top: 5px;
}
#chat-input-container {
display: block !important;
position: fixed;
bottom: 7px;
right: 12px;
text-align: right;
padding-top: 5px;
}
#chat-input-container button {
color: #222;
font-weight: bold;
box-shadow: 0 0 16px -2px rgba(0, 125, 255, 0.8);
font-family: Helvetica, Arial, sans-serif;
}
#chat_input{
background:rgba(20,20,20,0.6);
border:0;
border-radius:7px;
outline: 0 none;
width: 400px;
padding: 5px;
color: #ededed;
}
#chat_input:focus,
#chat_input:active {
    box-shadow: 0 0 16px -2px rgba(0, 125, 255, 0.8);
}

#log{
color:#b55;
text-align:center;
}
body>div{
	position:relative;
	text-align:center;
}
#chat-tooltip-container {
    background:rgba(20,20,20,0.6);
    max-height: 310px;
    border-radius:7px;
    overflow-y: auto;
    display: block !important;
    position: fixed;
    bottom: 40px;
    box-shadow: 0 0 16px -2px rgba(0,0,0,0.8);
    padding: 5px;
}
#chat-tooltip {
text-align:right;
}
#chat-tooltip>img {
cursor: pointer;
border: 2px solid transparent;
margin-bottom: 2px;
}
#chat-tooltip>img.highlighted {
box-shadow: 1px 1px 10px 4px rgba(0, 125, 255, 0.8);
}
#chat-tooltip>img:active {
box-shadow: 1px 1px 10px 4px rgba(255, 125, 0, 0.8);
}

.self-name {
font-weight: bold;
}
.loading {
background-image: url('loading.gif');
background-repeat: no-repeat;
background-position: center center;
min-height: 40px;
}
.cinema_bg{
background-image:url('cinema.jpg');
background-repeat: no-repeat;
background-position: center -188px;
background-size: 2100px auto;
}
.brokkoli_bg{
background-image:url('brokkoli.jpg');
background-repeat: no-repeat;
background-position: center top;
background-size: cover;
}
.cosmos_bg{
background-image:url('cosmos.jpg');
background-repeat: no-repeat;
background-position: center top;
background-size: cover;
}
.black-scales_bg{
background-image:url('black-scales.png');
background-repeat: repeat;
background-position: center center;
}
.diagmonds_bg{
background-image:url('diagmonds.png');
background-repeat: repeat;
background-position: center center;
}
</style>
	</head>
	<body onload="setBg(); setPoster();">
	<div id="main-content">
            <video width="1280" height="720" id="the-video" src="" poster=""></video>
			<div id="chat_cont" onclick="input.focus();">
				<div>
					<div id="username-container">Username:&nbsp;<span id="username"></span></div>
					<div id="users-title"><canvas id="logo" width="25" height="25"></canvas>Users</div>
				</div>
				<div>
					<div id="chat_window"></div>
					<div id="chat_users"></div>
					<div id="chat_channels"></div> 
				</div>
				<div id="chat-tooltip-container"><div id="chat-tooltip"></div></div>
				<div id="chat-input-container">
                    <button type="button" class="btn btn-warning btn-xs" onclick="javascript:setVideo()">SET VIDEO</button>
                                        
                    <input id="chat_input" type="text">&nbsp;<button type="button" class="btn btn-primary btn-xs" onclick="javascript:sendChat()">SEND</button>
                    <button type="button" class="btn btn-danger btn-xs" onclick="javascript:clearChatWindow()">CLEAR</button>
				</div>
			</div>
	</div>

		<div id="log"></div>
<script>

var users = [];
var channels = [];

if(window.location.hash == '#clear-name') {
    window.localStorage.username = '';
    window.location.hash = '';
}

var username = window.localStorage.username || '';
while(username == ''){
	username = prompt('Enter Username').replace(/\W+/g, "");
	window.localStorage.username = username;
}
$('#username').html(username);

var channel = 'ws-video-sync';
if(typeof btorrentChannelName === 'string') channel = btorrentChannelName;

function oc(e){
	console.log('connection opened');
	$.achex.send({cmd:'register_broadcast', bid:'achexchatdemo'});
	
	refreshUserList();
}


function cc(){
	$.achex.send({bc:'achexchatdemo', offline: username});
	console.log('closed');
}

var refreshTimeout = null;
function chatEvent(obj, raw){
	//logf(raw);
	//console.log(obj, raw);
	//var gaga = JSON.parse(raw);
	if(obj.bc == 'achexchatdemo'){
		if( obj.channel == channel && channel != '' ){
			// received chat
			rcvChat(obj);
		}else if(obj.req != null){
            if(obj.online != null) {
			    users = [];
			    clearTimeout(refreshTimeout);
			    refreshTimeout = setTimeout(refreshUserList, 60000);
			}
			// in channel info
			$.achex.send({bc:'achexchatdemo', inchannel: channel});
		}else if(obj.inchannel != null){
            if(users[obj.sID] == null){
                users[obj.sID]  = {c:String(obj.FROM)};
            }
		}else if(obj.gif != null) {
            var type = obj.gif.slice(-9);
            if(type === '/100.webp') {
                obj.gif = obj.gif.slice(0, obj.gif.length-9)+'/200.webp';
            }
            rcvChat(obj, '<img width="'+(obj.width*2)+'" height="'+(obj.height*2)+'" src="'+obj.gif+'" class="loading" />');
		}
		else if(obj.videoSrc != null) {
            TheVideoController.init('the-video');
            if(TheVideoController.video.currentSrc != unescape(obj.videoSrc)) {
                TheVideoController.video.src = unescape(obj.videoSrc);
                TheVideoController.video.load();
            }
		}
		else if(obj.snap != null) {
            rcvChat(obj, '<img src="'+unescape(obj.snap)+'" class="loading" />');
		}
		else if(obj.videoCurrSrc != null && obj.sID != $.achex.sid) {
            TheVideoController.syncToMaster(unescape(obj.videoCurrSrc), obj.videoPaused, obj.videoCurrTime, obj.videoEnded, obj.videoVolume, obj.videoMuted);
            //console.log('videoCurrSrc', obj);
		}
		else if(obj.poster != null) {
            document.getElementById('the-video').setAttribute('poster', unescape(obj.poster));
		}
		
		showUsers();
		
	}else if(obj.FROM != username){
		if( obj.req == 'info'){
			$.achex.send({bc:'achexchatdemo', inchannel: channel});
		}else{
			rcvWhisper(obj);
		}
	}
}

$.achex({
    dbg: 0,
	username: username,
	password:'none',
	reconnect: 3000,
	logo:{canvas:'logo', size:25},
	fade: true,
	opencallback: oc,
	callback: chatEvent,
	closecallback: cc
});


// ---- chat functions
function sendChat(){
	var str = input.value;
	if(channel != null && str != null){
        if(str === '/clear' || str ==='/cls') {
            clearChatWindow();
        }
        else if(str === '/name' || str === '/nick') {
            username = prompt('Enter Username').replace(/\W+/g, "");
            window.localStorage.username = username;
        }
        else if(str === '/setvideo' || str === '/video') {
            setVideo();
        }
        else if(str === '/getvideo') {
            var videoSrc = $('#the-video').currentSrc;//.attr('src');
            var c = !videoSrc?'No video source set.':escape(videoSrc);
            htmlToSelf(c);
        }
        else if(str === '/sync') {
            if(!TheVideoController.master && TheVideoController.video != null) {
                TheVideoController.master = true;
                setSync(true);
                htmlToSelf('Entered master mode...');
            }
            else {
                TheVideoController.master = false;
                htmlToSelf('Exited master mode...');
            }
        }
        else if(str.slice(0, 11) === '/setposter ' && !isNaN(str.split(' ')[1])) {
            setPoster(parseInt(str.split(' ')[1]));
        }
        else if(str.slice(0, 7) === '/setbg ' && !isNaN(str.split(' ')[1])) {
            setBg(parseInt(str.split(' ')[1]));
        }
        else if(str === '/snap') {
            var q = null;
            if(str.indexOf('/snap ') === 0 && str.length > 6) {
                if(!isNaN(str.split(' ')[1])) q = str.split(' ')[1];
            }
            if(TheVideoController.video) {
                TheVideoController.snap(q);
                if(TheVideoController.snapDataUrl !== null) {
                    var to_send = {bc:'achexchatdemo', snap: escape(TheVideoController.snapDataUrl) };
                    $.achex.send(to_send);
                }
            } else htmlToSelf('No video loaded...');
        }
        else if(str === '/help' || str === '/man') {
            var cmds = 'Available commands: <br>/help, /man '
                      +'<br>/clear, /cls '
                      +'<br>/name, /nick '
                      +'<br>/setvideo, /video '
                      +'<br>/getvideo '
                      +'<br>/setbg 0-'+(backgroundCs.length-1)+' '
                      +'<br>/setposter 0-'+(posterPs.length-1)+' '
                      +'<br>/gif %search '
                      +'<br>/giflate ?text '
                      +'<br>/sticker %search '
                      +'<br>/sticklate ?text '
                    //+'<br>/sync '
                    //+'<br>/snap %quality=60'
                      ;
            htmlToSelf(cmds);
        }
        else {
            var to_send = {bc:'achexchatdemo', channel: channel, msg : escape(str) };
            $.achex.send(to_send);
            //console.log(to_send);
        }
		input.value= '';
	}
}

function htmlToSelf(html) {
    var obj = {FROM:$.achex.username, sID:$.achex.sid};
    rcvChat(obj, '<i class="sys-msg">'+html+'</i>');
}

function setChannel(chan){
	channel = chan;
}

function sendWhisper(usr, str){
	$.achex.send({to:usr, channel:channel, msg:escape(str)});
}

function rcvChat(obj, html){
    if(lastUser != obj.sID) $('#chat_window').append(createChatMessage(obj, html));
	else $('#chat_window>div:last-child').append('<br>').append(createChatMessage(obj, html));
	input.scroll = input.scrollHeight;
}
function rcvWhisper(obj){
    if(lastUser != obj.sID) $('#chat_window').append('<br>').append(createChatMessage(obj)).css('color', '#ccc');
	else $('#chat_window>div:last-child').append('<br>').append(createChatMessage(obj)).css('color', '#ccc');
	input.scroll = input.scrollHeight;
}

var lastUser = null;
function createChatMessage(obj, html){
	var re = document.createElement('div');
	var msg = document.createElement('span');
	var from = document.createElement('span');

	from.className = 'from';
	from.innerHTML = obj.FROM;

	msg.className= 'msg';
	if(!html) {
        var msgText = esc(unescape(obj.msg));
        msgText = msgText.split(' ');
        
        for(var i = 0; i < msgText.length; i++) {
            if(msgText[i].substr(0, 7) === 'http://' || msgText[i].substr(0, 8) === 'https://') {
                msgText[i] = '<a href="'+msgText[i]+'" target="_blank">'+msgText[i]+'</a>';
            }
        }
        
        msg.innerHTML = msgText.join(' ');
    }
    else msg.innerHTML = html;
    
	if(obj.time != null){
		var time = document.createElement('span');
		time.innerHTML = obj.time;
		time.className = 'time';
	}
	//TODO: send timestamp

	if(lastUser != obj.sID) {
        re.appendChild(from);
        re.appendChild(document.createElement('br'));
        re.appendChild(msg);
	}
	else {
        re = msg;
	}

    lastUser = obj.sID;
	return re;
}

var input = document.getElementById('chat_input');

input.onkeypress = function(e){
    //console.log('onkeypress', e.keyCode);
	switch(e.keyCode){
		case 13:
            if(input.value.slice(0, 9) === '/giflate ' 
            || (input.value.slice(0, 5) === '/gif ') 
            || input.value === '/gif' 
            || input.value.slice(0, 9) === '/sticklate ' 
            || (input.value.slice(0, 9) === '/sticker ') 
            || input.value === '/sticker' ) {
                var highlighted = $('#chat-tooltip > img.highlighted');
                if(highlighted.length !== 0) {
                    input.value = '';
                    sendGif(highlighted.get(0));
                }
            }
            else sendChat();
		break;
	}
};
window.onkeydown = function(e) {
    //console.log('e.keyCode', e.keyCode);
    if(((37 > e.keyCode || e.keyCode > 40) && e.keyCode !== 27) ||  $('#chat-tooltip > img').length === 0) return true;
    
    var highlighted = $('#chat-tooltip > img.highlighted');
    if(highlighted.length === 0 && e.keyCode !== 27) setHighlightedGif($('#chat-tooltip > img').get(0));
    else {
        var newHighlighted = null;
        switch(e.keyCode){
            case 27:
                destroyGifSearch();
                input.value = '';
                break;
            case 37:
                newHighlighted = highlighted.first().prev('img');
                break;
            case 38:
                newHighlighted = findUp(highlighted.first());
                if(!newHighlighted) newHighlighted = highlighted.first().prev('img');
                break;
            case 39:
                newHighlighted = highlighted.first().next('img');
                break;
            case 40:
                newHighlighted = findDown(highlighted.first());
                if(!newHighlighted) newHighlighted = highlighted.first().next('img');
                break;
        }
        
        //console.log('newHighlighted', newHighlighted);
        if(newHighlighted !== null && newHighlighted.length !== 0) setHighlightedGif(newHighlighted.get(0));
    }
};

input.onkeyup = function(e) {
    setTimeout(checkForCmd, 0);
};
function checkForCmd() {
    if(input.value.slice(0, 9) === '/giflate ' && input.value.length > 9) {
        gifSearchMaybe('gifs/translate?s='+encodeURI(input.value.substr(9))+'&');
    }
    else if(input.value.slice(0, 4) === '/gif') {
        if(input.value.slice(0, 5) === '/gif ' && input.value.length > 5) {
            gifSearchMaybe('gifs/search?q='+encodeURI(input.value.substr(5))+'&');
        }
        else {
            gifSearchMaybe('gifs/trending?');
        }
    }
    else if(input.value.slice(0, 11) === '/sticklate ' && input.value.length > 11) {
        gifSearchMaybe('stickers/translate?s='+encodeURI(input.value.substr(11))+'&');
    }
    else if(input.value.slice(0, 8) === '/sticker') {
        if(input.value.slice(0, 9) === '/sticker ' && input.value.length > 9) {
            gifSearchMaybe('stickers/search?q='+encodeURI(input.value.substr(9))+'&');
        }
        else {
            gifSearchMaybe('stickers/trending?');
        }
    }
    else {
        destroyGifSearch();
    }
}
/*input.onchange = function(e){
	if(input.value.trim() == '') {
        
	}
}*/
function showUsers(){
	$('#chat_users').html('');
	for(var i in users){
		$('#chat_users').append('<div title="'+i+'" '+($.achex.sid==i?'class="self-name"':'')+'>'+esc(users[i].c)+'</div>');
	}
}
// ----

function logf(str){
	$('#log').append(str+'<br>')
}
input.focus();

function esc(str) {
    return str.replace('<', '&lt;').replace('>', '&gt;').replace('"', '&quote;').replace("'", '&#8217;');
}

function refreshUserList() {
    $.achex.send({bc:'achexchatdemo', online: username, req:'info'});
}

function clearChatWindow() {
    $('#chat_window').html('');
    lastUser = null;
}

var gifSearchTimeout = null;
var gifSearchLatest = null;
function gifSearchMaybe(endPoint) {
    //console.log(gifSearchLatest, endPoint);
    if(endPoint === null || gifSearchLatest === endPoint) return;
    gifSearchLatest = endPoint;

    if(gifSearchTimeout) clearTimeout(gifSearchTimeout);
    gifSearchTimeout = setTimeout(giphySearch, 1000, endPoint);
}

function giphySearch(endPoint) {
    if(gifSearchTimeout) clearTimeout(gifSearchTimeout);
    gifSearchTimeout = null;
    if(!endPoint) return;

    $('#chat-tooltip').addClass('loading').html('');
    //todo: load more from offset when scrollbar is at bottom

    $.ajax({
        url: 'http://api.giphy.com/v1/'+endPoint+'limit=100&api_key=dc6zaTOxFJmzC',
        dataType: 'json',
        success: function(gifs){
            if(endPoint === gifSearchLatest) {
                if(gifs.data.length === 0) destroyGifSearch();
                else {
                    showGifs(gifs.data);
                }
            }
            //console.log(endPoint, gifs.data[0].images.fixed_height_small.webp);
            //src: images.fixed_height_small.webp
            //images.fixed_height_small.height
            //images.fixed_height_small.width
            //<img src="http://media2.giphy.com/media/3ogmaPGsQOruw/200.webp" height="200">
        }
    }).done(function(){
        //tooltip.fadeIn(document.getElementById('tooltip'));
    });
}

function destroyGifSearch() {
    if(!gifSearchLatest) return;
    //console.log('destroyGifSearch');
    if(gifSearchTimeout) clearTimeout(gifSearchTimeout);
    gifSearchTimeout = null;
    gifSearchLatest = null;
    $('#chat-tooltip').removeClass('loading').html('');
}

function showGifs(data) {
    if(!!data.images) data = [data];
    $('#chat-tooltip').removeClass('loading');
    for(var i = 0; i < data.length; i++) {
        var img = new Image();
        
        var w, h, url;
        
        if(!data[i].images.fixed_height_small.webp) {
            url = data[i].images.fixed_height.url;
            w = parseInt(data[i].images.fixed_height.width / 2);
            h = parseInt(data[i].images.fixed_height.height / 2);
        }
        else {
            url = data[i].images.fixed_height_small.webp;
            w = data[i].images.fixed_height_small.width;
            h = data[i].images.fixed_height_small.height;
        }
        
        //$(img).attr('rel', url);
        $(img).attr('width', w);
        $(img).attr('height', h);
        $(img).addClass('loading');
        img.onload = function(e) {
            $(this).removeClass('loading');
            /*var n = $(this).removeClass('loading').next('img');
            var r = 0;
            while(n && n.length !== 0 && n.attr('rel') && !n.attr('src')) {
                r++;
                n.attr('src', n.attr('rel'));
                n.attr('rel', '');
                
                if(r >= 2) break;
                n = n.next('img');
            }*/
        };
        img.onerror = img.onload;
        img.onmouseover = function(e) {
            setHighlightedGif(this, true);
        };
        img.onclick = function(e) {
            input.value = '';
            sendGif(this);
        };
        $(img).attr('src', url);
        $('#chat-tooltip').append(img);
    }
    //$('#chat-tooltip img').first().attr('src', $('#chat-tooltip img').first().attr('rel'));
}

function setHighlightedGif(node, dontScroll) {
    $('#chat-tooltip > img.highlighted').removeClass('highlighted');
    if(node) {
        $(node).addClass('highlighted');
        if(!dontScroll) node.scrollIntoView(false);
        //scrollIntoViewIfNeeded(node);
        return node;
    }
}

function findUp(node) {
  return findInSiblings(node, node.prevAll('img'));
}
function findDown(node) {
  return findInSiblings(node, node.nextAll('img'));
}


function findInSiblings(node, siblings) {
  var x = node.prop('offsetLeft'),
    w = node.width() / 2;
  //console.log('x', x, 'w', w);
  for (var i = 0; i < siblings.length; i++) {
    var sibling = $(siblings[i]);
    if (sibling[0].nodeType === 1) {
      var offset = sibling.prop('offsetLeft');
      var width = sibling.width();
      //console.log('offset', offset, 'width', width);
      /*if (offset - w < x && offset + w > x) {*/
      if(x+w > offset-4 && x+w < offset+width+4) {
          return sibling;
      }
    }
  }
  return null;
}

function sendGif(img) {
	if(img){
		var to_send = {bc:'achexchatdemo', gif: img.src, width: img.width, height: img.height };
		$.achex.send(to_send);
		
		destroyGifSearch();
        input.value = '';
	}
}

function setVideo() {
    var videoSrc = prompt('Insert video source URL', 'http://webtorrent.io/torrents/sintel-1024-surround.mp4');//http://clips.vorwaerts-gmbh.de/VfE_html5.mp4
    if(videoSrc !== null && videoSrc.length > 10 && videoSrc.trim().substr(0, 7) === 'http://' || videoSrc.trim().substr(0, 8) === 'https://') {
        var to_send = {bc:'achexchatdemo', videoSrc: escape(videoSrc.trim()) };
		$.achex.send(to_send);
    }
}

function setSync(force){
	//if(TheVideoController.master){
	if(force || (TheVideoController.video && !TheVideoController.ignoreEvents)){
		var to_send = {
            bc:'achexchatdemo', 
            videoCurrSrc: escape(TheVideoController.video.currentSrc),
            videoPaused: TheVideoController.video.paused, 
            videoCurrTime: TheVideoController.video.currentTime,
            videoEnded: TheVideoController.video.ended,
            videoVolume: TheVideoController.video.volume,
            videoMuted: TheVideoController.video.muted
		};
		$.achex.send(to_send);
		//console.log('setSync', to_send);
	}
}

// ## THE-VIDEO ##

var TheVideoController = {
    video: null,
    canvas:null,
    w:null,
    h:null,
    duration:null,
    snapDataUrl:null,
    master: false,
    ignoreEvents: false,
    ignoreEventsTimer: null,
    ignoreDelay: 2000,
    
    init: function(videoId) {
		this.video = document.getElementById(videoId);
		this.canvas = document.createElement('CANVAS');
		this.context = this.canvas.getContext('2d');

		this.addListeners();
	},

	addListeners: function() {
		this.video.onmouseover = function (e) {
            this.setAttribute("controls", "controls");
        };
        //this.video.onmousemove = this.video.onmouseover;
        this.video.onmouseout = function (e) {
            this.removeAttribute("controls");
        };
        
        this.video.ondblclick = function (e) {
            if(TheVideoController.video.paused) TheVideoController.video.play();
            else TheVideoController.video.pause();
        }
        
		this.video.onloadedmetadata = function(e) {
            TheVideoController.w = this.videoWidth;
			TheVideoController.h = this.videoHeight;
			TheVideoController.canvas.width = TheVideoController.w;
			TheVideoController.canvas.height = TheVideoController.h;
			TheVideoController.duration = this.duration;
		};
		
		//this.video.oncanplaythrough = function(e) {
        //  //console.log('oncanplaythrough');
		//};
		
		//this.video.onended = function(e) {
        //  //console.log('onended');
		//};
		
		this.video.onpause = function(e) {
            //console.log('onpause');
            setSync();
		};
		//this.video.onplay = function(e) {
        //    console.log('onplay');
		//};
		
		this.video.onplaying  = function(e) {
            //console.log('onplaying');
            setSync();
		};
		
		this.video.onseeked  = function(e) {
            //console.log('onseeked');
            setSync();
		};

		this.video.onwaiting  = function(e) {
            //console.log('onwaiting');
            //TODO: send msg: buffering...
		};
	},

    snap: function (q) {
        if(!q || q > 100 || q < 1) q = 60;
        this.context.fillRect(0, 0, this.w, this.h);
        this.context.drawImage(this.video, 0, 0, this.w, this.h);
        try{
            this.snapDataUrl = this.canvas.toDataURL('image/jpeg',q/100);
        } catch(e){
            this.snapDataUrl = null;
            //htmlToSelf(' ');
            //$('.sys-msg:last-child').last().append(this.canvas);
        }
    },
    
    syncToMaster: function (src, paused, time, ended, volume, muted) {
        //console.log(src, paused, time, ended, volume, muted);
        if(this.master) return;
        
        this.ignoreEvents = true;
        if(this.ignoreEventsTimer) clearTimeout(this.ignoreEventsTimer);
        this.ignoreEventsTimer = setTimeout(function(){
            TheVideoController.ignoreEvents = false;
        }, this.ignoreDelay);

        if(TheVideoController.video == null) TheVideoController.init('the-video');
        if(TheVideoController.video.currentSrc != src) {
            TheVideoController.video.src = src;
            TheVideoController.video.load();
        }

        if(TheVideoController.video.paused !== paused) {
            if(!paused && (TheVideoController.video.paused || !TheVideoController.video.ended)) TheVideoController.video.play();
            else if(paused) TheVideoController.video.pause();
        }

        console.log(TheVideoController.video.currentTime, time);
        TheVideoController.video.currentTime = time;

        //TheVideoController.video.volume = volume;
        //TheVideoController.video.muted = muted;
    }
};

var posterPs = [
    {url:''},
    {url:'http://media2.giphy.com/media/OoVaSYA6NqQrC/giphy.webp'},
    {url:'http://media2.giphy.com/media/142xSjESUD0nba/giphy.webp'},
    {url:'http://media2.giphy.com/media/l41YA9ybYj0sfvECQ/giphy.webp'},
    {url:'http://media2.giphy.com/media/ppYoMtU8ZnOaQ/giphy.webp'}
];
function setPoster(n) {
    if(typeof(window.localStorage.poster) === 'undefined' 
    || isNaN(window.localStorage.poster)
    || typeof(posterPs[window.localStorage.poster]) !== 'object') {
        window.localStorage.poster = 0;
    }
    
    if(isNaN(n) || typeof(posterPs[n]) !== 'object') n = window.localStorage.poster;
    else window.localStorage.poster = n;
    document.getElementById('the-video').setAttribute('poster', posterPs[n].url);
}


</script>
        
        
        <!-- src @ github.com/a-sync/ws-video-sync -->
	</body>
</html>
