<!DOCTYPE html>
<html>
	<head>
		<title>TEST - Chat</title>

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="mobile-web-app-capable" content="yes">

		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" >

		<link rel="icon" href="favicon.png">
		<link rel="apple-touch-icon" href="favicon.png">
		<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
		<script src="JQ.js"></script>
		<!-- <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script> -->
		<script src="jquery.achexws.js"></script>
<style>
html,body{
background-image:url('bg.jpg');
}
.from{
padding-right:10px;
font-weight:bold;
}
.msg{
color:#333;
}

#chat_cont{
display:inline-block;
text-align:left;
}
#chat_cont> div{
display:table-row;
}
#chat_cont > div> div{
display:table-cell;
}

#username{
font-weight:bold;
}
#chat_window{
background:rgba(255,255,255,0.8);
border:1px solid;
border-radius:7px;
min-width:300px;
height:400px;
overflow-y:auto;
}
#chat_users{
background:rgba(255,255,255,0.8);
height:400px;
border:1px solid;
border-radius:7px;
overflow-y:auto;
}
#log{
color:#555;
text-align:center;
}
body>div{
	position:relative;
	text-align:center;
}
</style>
	</head>
	<body>
	<div>
			<canvas id="logo" width="50px" height="50px"></canvas><br>
			<div id="chat_cont">
				<div>
					<div>Username:&nbsp;<span id="username"></span></div>
					<div>Users:</div>
				</div>
				<div>
					<div id="chat_window"></div>
					<div id="chat_users"></div>
					<div id="chat_channels"></div> 
				</div>
				<div>
					<input id="chat_input" type="text">&nbsp;<button style="" type="button" class="btn btn-primary btn-xs" onclick="javascript:sendChat()">SEND</button>
					<button style="" type="button" class="btn btn-warning btn-xs" onclick="javascript:sendSync()">SYNC</button>
					<button style="" type="button" class="btn btn-info btn-xs" onclick="javascript:searchGiphy()">GIPHY</button>
				</div>
			</div>
	</div>

		<div id="log"></div>
<script>

var users = [];
var channels = [];

if(window.location.hash == '#clear-name') {
    window.localStorage.username = '';
    window.location.hash = '';
}

var username = window.localStorage.username || '';
while(username == ''){
	username = prompt('Enter Username');
	window.localStorage.username = username;
}
$('#username').html(username);

var channel = 'btorrent-movie';
if(typeof btorrentChannelName === 'string') channel = btorrentChannelName;

function oc(e){
	console.log('connection opened');
	$.achex.send({cmd:'register_broadcast', bid:'achexchatdemo'});
	
	refreshUserList();
}


function cc(){
	$.achex.send({bc:'achexchatdemo', offline: username});
	console.log('closed');
}

var refreshTimeout = null;
function chatEvent(obj, raw){
	//logf(raw);
	//console.log(obj);
	//var gaga = JSON.parse(raw);
	if(obj.bc == 'achexchatdemo'){
		if( obj.channel == channel && channel != '' ){
			// received chat
			rcvChat(obj);
		}else if(obj.req != null){
            if(obj.online != null) {
			    users = [];
			    clearTimeout(refreshTimeout);
			    refreshTimeout = setTimeout(refreshUserList, 30000);
			}
			// in channel info
			$.achex.send({bc:'achexchatdemo', inchannel: channel});
		}else if(obj.inchannel != null){
            if(users[obj.sID] == null){
                users[obj.sID]  = {c:String(obj.FROM)};
            }
		}else if(obj.videoState !== null) {
            console.log('videoState', obj);
		}
		
		showUsers();
		
	}else if(obj.FROM != username){
		if( obj.req == 'info'){
			$.achex.send({bc:'achexchatdemo', inchannel: channel});
		}else{
			rcvWhisper(obj);
		}
	}
}

$.achex({
    dbg: 1,
	username: username,
	password:'none',
	reconnect: 3000,
	logo:{canvas:'logo'},
	fade: true,
	opencallback: oc,
	callback: chatEvent,
	closecallback: cc
});


// ---- chat functions
function sendChat(){
	var str = input.value;
	if(channel != null && str != null){
		var to_send = {bc:'achexchatdemo', channel: channel, msg : escape(str) };
		$.achex.send(to_send);
		console.log(to_send);
		input.value= '';
	}
}

function setChannel(chan){
	channel = chan;
}

function sendWhisper(usr, str){
	$.achex.send({to:usr, channel:channel, msg:escape(str)});
}

function rcvChat(obj){
	$('#chat_window').append(createChatMessage(obj));
	input.scroll = input.scrollHeight;
}
function rcvWhisper(obj){
	$('#chat_window').append(createChatMessage(obj)).css('color', '#ccc');
	input.scroll = input.scrollHeight;
}

function createChatMessage(obj){
	var div = document.createElement('div');
	var msg = document.createElement('span');
	var from = document.createElement('span');

	from.className = 'from';
	from.innerHTML = obj.FROM+ ':';

	msg.className= 'msg';
	msg.innerHTML = esc(unescape(obj.msg));

	if(obj.time != null){
		var time = document.createElement('span');
		time.innerHTML = obj.time;
		time.className = 'time';
	}
	//TODO: time, giphy
	div.appendChild(from);
	div.appendChild(msg);
	return div;
}

var input = document.getElementById('chat_input');

input.onkeypress = function(e){
	switch(e.keyCode){
		case 13:
			sendChat();
			break;
	}
	//TODO: giphy tooltip on timeout
}
function showUsers(){
	$('#chat_users').html('');
	for(var i in users){
		$('#chat_users').append('<div title="'+i+'">'+esc(users[i].c)+'</div>');
	}
}
// ----

function logf(str){
	$('#log').append(str+'<br>')
}
input.focus();

function esc(str) {
    return str.replace('<', '&lt;').replace('>', '&gt;').replace('"', '&quote;').replace("'", '&#8217;');
}

function refreshUserList() {
    $.achex.send({bc:'achexchatdemo', online: username, req:'info'});
}

function sendSync(){
	var videoState = 'playing';
	var videoTime = '0:0:22';
	if(channel != null){
		var to_send = {bc:'achexchatdemo', videoState: videoState, videoTime: videoTime };
		$.achex.send(to_send);
		console.log(to_send);
	}
}

function searchGiphy(){
	var str = input.value;
	if(str != null){
		giphySearch(str);
		input.value= '';
	}
}

var giphySearchLatest = null;
function giphySearch(str) {
    giphySearchLatest = str;
    $.ajax({
        url: 'http://api.giphy.com/v1/gifs/search?q='+ str.replace(/ /g, '+') +'&limit=100&api_key=dc6zaTOxFJmzC&fmt=html',
        dataType: 'json',
        success: function(gifs){
            console.log(gifs);
            //src: images.fixed_height.webp
            //images.fixed_height.height
            //images.fixed_height.width
            //<img src="http://media2.giphy.com/media/3ogmaPGsQOruw/200.webp" height="200">
        }
    }).done(function(){
        //tooltip.fadeIn(document.getElementById('tooltip'));
    });
}

</script>
        
        
        
	</body>
</html>
